import UseStoreDemo from "@site/src/demo/UseStoreDemo";

# 简单实现 redux 的 useStore

## 初始化状态

```tsx
type StoreState = {
  numberA?: number;
  numberB?: number;
};

let memoryState: StoreState = {};
```

## 状态监听器

```tsx
const listeners: ((state: StoreState) => void)[] = [];
```

## reducer 函数

```tsx
enum ActionType {
  /**
   *  更新数字A
   */
  UPDATE_NUMBER_A = "UPDATE_NUMBER_A",
  /**
   *  更新数字B
   */
  UPDATE_NUMBER_B = "UPDATE_NUMBER_B",
  /**
   *  重置状态
   */
  RESET_NUMBER = "RESET_NUMBER",
}

type StoreAction =
  | {
      type: ActionType.UPDATE_NUMBER_A;
      value: number;
    }
  | {
      type: ActionType.UPDATE_NUMBER_B;
      value: number;
    };

const reducer = (state: StoreState, action: StoreAction): StoreState => {
  switch (action.type) {
    case ActionType.UPDATE_NUMBER_A:
      return {
        ...state,
        numberA: action.value,
      };
    case ActionType.UPDATE_NUMBER_B:
      return {
        ...state,
        numberB: action.value,
      };
    case ActionType.RESET_NUMBER:
      return {};
    default:
      return state;
  }
};
```

## dispatch

```tsx
const dispatch = (action: StoreAction) => {
  memoryState = reducer(memoryState, action);
  listeners.forEach((listener) => {
    listener(memoryState);
  });
};
```

## useStore

```tsx
const useStore = () => {
  const [state, setState] = useState(memoryState);

  useEffect(() => {
    listeners.push(setState);
    return () => {
      const index = listeners.indexOf(setState);
      if (index > -1) {
        listeners.splice(index, 1);
      }
    };
  }, [state]);

  return state;
};
```

## 演示

<a
  style={{ marginBottom: 16 }}
  href="https://github.com/monhan-97/monhan-97.github.io/tree/main/src/demo/UseStoreDemo"
>
  源码地址
</a>

<UseStoreDemo />
