"use strict";(self.webpackChunkhuangmh_blog=self.webpackChunkhuangmh_blog||[]).push([[6329],{4803:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"Promise/promise-implement","title":"\u624b\u5199 Promise","description":"Promise \u5185\u90e8\u5b9e\u73b0","source":"@site/docs/Promise/promise-implement.mdx","sourceDirName":"Promise","slug":"/Promise/promise-implement","permalink":"/docs/Promise/promise-implement","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedBy":"mohan-97","lastUpdatedAt":1724514159000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"async \u548c await","permalink":"/docs/Promise/async-await"},"next":{"title":"\u7ec3\u4e60\u9898","permalink":"/docs/Promise/test-case"}}');var s=n(3274),o=n(8438);const i={},a="\u624b\u5199 Promise",l={},c=[{value:"Promise \u5185\u90e8\u5b9e\u73b0",id:"promise-\u5185\u90e8\u5b9e\u73b0",level:2},{value:"\u5b9e\u73b0 Promise.resolve \u9759\u6001\u65b9\u6cd5",id:"\u5b9e\u73b0-promiseresolve-\u9759\u6001\u65b9\u6cd5",level:2},{value:"\u5b9e\u73b0 Promise.reject \u9759\u6001\u65b9\u6cd5",id:"\u5b9e\u73b0-promisereject-\u9759\u6001\u65b9\u6cd5",level:2},{value:"\u5b9e\u73b0 Promise.all \u9759\u6001\u65b9\u6cd5",id:"\u5b9e\u73b0-promiseall-\u9759\u6001\u65b9\u6cd5",level:2},{value:"\u5b9e\u73b0 Promise.allSettled \u9759\u6001\u65b9\u6cd5",id:"\u5b9e\u73b0-promiseallsettled-\u9759\u6001\u65b9\u6cd5",level:2},{value:"\u5b9e\u73b0 Promise.race \u9759\u6001\u65b9\u6cd5",id:"\u5b9e\u73b0-promiserace-\u9759\u6001\u65b9\u6cd5",level:2}];function d(e){const r={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"\u624b\u5199-promise",children:"\u624b\u5199 Promise"})}),"\n",(0,s.jsx)(r.h2,{id:"promise-\u5185\u90e8\u5b9e\u73b0",children:"Promise \u5185\u90e8\u5b9e\u73b0"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-tsx",metastring:"title='MyPromise.ts'",children:'export enum PromiseState {\r\n  pending = "pending",\r\n  fulfilled = "fulfilled",\r\n  rejected = "rejected",\r\n}\r\n\r\ntype PromiseOnFulfilled<T extends unknown> = (value: T) => void;\r\n\r\ntype PromiseOnRejected = (reason: any) => void;\r\n\r\ntype PromiseHandler<T> = {\r\n  state: keyof typeof PromiseState;\r\n  executor?: PromiseOnFulfilled<T> | PromiseOnRejected;\r\n  resolve: PromiseOnFulfilled<T>;\r\n  reject: PromiseOnRejected;\r\n};\r\n\r\n/**\r\n * \u628a\u4e00\u4e2a\u51fd\u6570\u653e\u5230\u5fae\u961f\u5217\u91cc\u9762\u53bb\r\n */\r\nconst runMicroTask = (callback: () => void) => {\r\n  const p = document.createElement("p");\r\n  const observer = new MutationObserver(() => {\r\n    callback();\r\n  });\r\n  observer.observe(p, {\r\n    childList: true,\r\n  });\r\n  p.innerHTML = "1";\r\n};\r\n\r\nconst isPromise = (obj: any) => {\r\n  return !!(obj && typeof obj === "object" && typeof obj.then === "function");\r\n};\r\n\r\nclass MyPromise<T extends unknown> {\r\n  /**\r\n   * \u5185\u90e8\u72b6\u6001\r\n   */\r\n  private state: keyof typeof PromiseState = PromiseState.pending;\r\n\r\n  private value: T | undefined = undefined;\r\n\r\n  /**\r\n   * \u5b58\u653ethen\u51fd\u6570\u91cc\u9762onFulfilled \u548c onRejected \u7684\u56de\u8c03\u51fd\u6570\r\n   * \u901a\u8fc7 state \u6765\u533a\u5206 \u5b58\u653e\u7684\u662f \u6ce8\u518c\u7684\u56de\u8c03\u51fd\u6570 \u8fd8\u662f\u5931\u8d25\u7684\u56de\u8c03\u51fd\u6570\r\n   */\r\n  private handlers: PromiseHandler<T>[] = [];\r\n\r\n  /**\r\n   * \u521b\u5efa\u4e00\u4e2aPromise\r\n   * @param executor {Function}\r\n   */\r\n  constructor(\r\n    executor: (\r\n      resolve: PromiseOnFulfilled<T>,\r\n      reject: PromiseOnRejected\r\n    ) => void\r\n  ) {\r\n    try {\r\n      executor(this.resolve, this.reject);\r\n    } catch (e) {\r\n      this.reject(e);\r\n    }\r\n  }\r\n\r\n  private resolve = (value?: T) => {\r\n    this.changeState(PromiseState.fulfilled, value);\r\n  };\r\n\r\n  private reject = (reason: any) => {\r\n    this.changeState(PromiseState.rejected, reason);\r\n  };\r\n\r\n  /**\r\n   * \u66f4\u6539 \u4efb\u52a1\u7684\u72b6\u6001\r\n   * @param state\r\n   * @param value\r\n   * @returns\r\n   */\r\n  private changeState = (state: PromiseState, value: T | undefined) => {\r\n    if (this.state !== PromiseState.pending) {\r\n      return;\r\n    }\r\n    this.state = state;\r\n    this.value = value;\r\n    //\u72b6\u6001\u53d8\u5316\u6267\u884c\u961f\u5217\r\n    this.runHandlers();\r\n  };\r\n\r\n  /**\r\n   * \u628a onFulfilled \u548c onRejected \u6dfb\u52a0\u5230\u4efb\u52a1\u961f\u5217\u91cc\u9762\u53bb\r\n   * @param executor\r\n   * @param state\r\n   */\r\n  private pushHandlers = (\r\n    executor: PromiseHandler<T>["executor"],\r\n    state: PromiseHandler<T>["state"],\r\n    resolve: PromiseHandler<T>["resolve"],\r\n    reject: PromiseHandler<T>["reject"]\r\n  ) => {\r\n    this.handlers.push({\r\n      state,\r\n      executor,\r\n      resolve,\r\n      reject,\r\n    });\r\n  };\r\n\r\n  /**\r\n   * \u6267\u884c\u6ce8\u518c\u5230\u6570\u7ec4\u961f\u5217\u91cc\u9762\u7684\u51fd\u6570\r\n   */\r\n  private runHandlers = () => {\r\n    if (this.state === PromiseState.pending) {\r\n      return;\r\n    }\r\n    while (this.handlers[0]) {\r\n      this.runHandler(this.handlers[0]);\r\n      this.handlers.shift();\r\n    }\r\n  };\r\n\r\n  private runHandler = (handle: PromiseHandler<T>) => {\r\n    runMicroTask(() => {\r\n      if (handle.state !== this.state) {\r\n        return;\r\n      }\r\n      if (typeof handle.executor !== "function") {\r\n        this.state === PromiseState.fulfilled\r\n          ? handle.resolve(this.value as T)\r\n          : handle.reject(this.value);\r\n        return;\r\n      }\r\n      try {\r\n        const result = handle.executor(this.value as T);\r\n        if (isPromise(result)) {\r\n          result.then(handle.resolve, handle.reject);\r\n        } else {\r\n          handle.resolve(result as T);\r\n        }\r\n      } catch (error) {\r\n        handle.reject(error);\r\n      }\r\n    });\r\n  };\r\n\r\n  /**\r\n   * then \u6ce8\u518c\u7684 onFulfilled \u548c onRejected \u7684\u56de\u8c03\u51fd\u6570\u4e0d\u4f1a\u7acb\u5373\u6267\u884c \u4f1a\u653e\u5230\u5fae\u961f\u5217\u91cc\u9762\u53bb\r\n   * @param onFulfilled\r\n   * @param onRejected\r\n   * @returns MyPromise\r\n   */\r\n  then = (\r\n    onFulfilled?: PromiseOnFulfilled<T>,\r\n    onRejected?: PromiseOnRejected\r\n  ) => {\r\n    return new MyPromise((resolve, reject) => {\r\n      this.pushHandlers(onFulfilled, PromiseState.fulfilled, resolve, reject);\r\n      this.pushHandlers(onRejected, PromiseState.rejected, resolve, reject);\r\n      this.runHandlers();\r\n    });\r\n  };\r\n\r\n  /**\r\n /**\r\n   * then\u51fd\u6570 \u6355\u83b7\u5f02\u5e38\u9519\u8bef\u7684\u7b80\u5199\r\n   * @param onRejected\r\n   * @returns MyPromise\r\n   */\r\n  catch = (onRejected: PromiseOnRejected) => {\r\n    return this.then(undefined, onRejected);\r\n  };\r\n\r\n  /**\r\n   * \u5f53\u4efb\u52a1\u72b6\u6001\u4e0d\u662fpending\u7684\u65f6\u5019 \u5c31\u4f1a\u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\r\n   * @param onSettled\r\n   * @returns MyPromise\r\n   */\r\n  finally = (onSettled: () => void) => {\r\n    return this.then(\r\n      (data) => {\r\n        onSettled();\r\n        return data;\r\n      },\r\n      (reason) => {\r\n        onSettled();\r\n        return reason;\r\n      }\r\n    );\r\n  };\r\n}\r\n\r\nexport default MyPromise;\n'})}),"\n",(0,s.jsx)(r.h2,{id:"\u5b9e\u73b0-promiseresolve-\u9759\u6001\u65b9\u6cd5",children:"\u5b9e\u73b0 Promise.resolve \u9759\u6001\u65b9\u6cd5"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:"/**\r\n * 1\u3001\u4f20\u5165\u7684data\u53ef\u80fd\u662fES6\u7684Promise\r\n * 2\u3001\u4f20\u5165\u7684data\u4e5f\u53ef\u80fd\u662fPromiseLike (Promise A+)\u7684Promise \u72b6\u6001\u548c\u5176\u4fdd\u6301\u4e00\u81f4\u5373\u53ef\r\n */\r\nPromise.resolve = function (data) {\r\n  if (data instanceof Promise) {\r\n    return data;\r\n  }\r\n  return new Promise((resolve, reject) => {\r\n    if (isPromise(data)) {\r\n      data.then(resolve, reject);\r\n    } else {\r\n      resolve(data);\r\n    }\r\n  });\r\n};\n"})}),"\n",(0,s.jsx)(r.h2,{id:"\u5b9e\u73b0-promisereject-\u9759\u6001\u65b9\u6cd5",children:"\u5b9e\u73b0 Promise.reject \u9759\u6001\u65b9\u6cd5"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:"Promise.reject = function (reason) {\r\n  return new Promise((resolve, reject) => {\r\n    reject(reason);\r\n  });\r\n};\n"})}),"\n",(0,s.jsx)(r.h2,{id:"\u5b9e\u73b0-promiseall-\u9759\u6001\u65b9\u6cd5",children:"\u5b9e\u73b0 Promise.all \u9759\u6001\u65b9\u6cd5"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:"Promise.all = function (task) {\r\n  return new Promise((resolve, reject) => {\r\n    try {\r\n      let count = 0;\r\n      let fulfilledCount = 0;\r\n      let result = [];\r\n\r\n      for (const iterator of task) {\r\n        let i = count;\r\n        count++;\r\n        Promise.resolve(iterator).then((data) => {\r\n          fulfilledCount++;\r\n          result[i] = data;\r\n          if (fulfilledCount === count) {\r\n            resolve(result);\r\n          }\r\n        }, reject);\r\n      }\r\n\r\n      if (count === 0) {\r\n        resolve(result);\r\n      }\r\n    } catch (error) {\r\n      reject(error);\r\n    }\r\n  });\r\n};\n"})}),"\n",(0,s.jsx)(r.h2,{id:"\u5b9e\u73b0-promiseallsettled-\u9759\u6001\u65b9\u6cd5",children:"\u5b9e\u73b0 Promise.allSettled \u9759\u6001\u65b9\u6cd5"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:'Promise.allSettled = function (task) {\r\n  const promiseHandlers = [];\r\n  for (const iterator of task) {\r\n    promiseHandlers.push(\r\n      iterator.then(\r\n        (data) => {\r\n          return {\r\n            value: data,\r\n            status: "fulfilled",\r\n          };\r\n        },\r\n        (reason) => {\r\n          return {\r\n            reason: reason,\r\n            status: "rejected",\r\n          };\r\n        }\r\n      )\r\n    );\r\n  }\r\n  return Promise.all(promiseHandlers);\r\n};\n'})}),"\n",(0,s.jsx)(r.h2,{id:"\u5b9e\u73b0-promiserace-\u9759\u6001\u65b9\u6cd5",children:"\u5b9e\u73b0 Promise.race \u9759\u6001\u65b9\u6cd5"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:"Promise.race = function (task) {\r\n  return new Promise((resolve, reject) => {\r\n    for (const iterator of task) {\r\n      Promise.resolve(iterator).then(resolve, reject);\r\n    }\r\n  });\r\n};\n"})})]})}function u(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8438:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>a});var t=n(9474);const s={},o=t.createContext(s);function i(e){const r=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(o.Provider,{value:r},e.children)}}}]);