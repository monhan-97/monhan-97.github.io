"use strict";(self.webpackChunkhuangmh_blog=self.webpackChunkhuangmh_blog||[]).push([[6329],{3881:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>a});var t=r(8101);const s={},o=t.createContext(s);function i(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(o.Provider,{value:n},e.children)}},7087:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"Promise/promise-implement","title":"\u624b\u5199 Promise","description":"Promise \u5185\u90e8\u5b9e\u73b0","source":"@site/docs/Promise/promise-implement.mdx","sourceDirName":"Promise","slug":"/Promise/promise-implement","permalink":"/docs/Promise/promise-implement","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedBy":"mohan-97","lastUpdatedAt":1724514159000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"async \u548c await","permalink":"/docs/Promise/async-await"},"next":{"title":"\u7ec3\u4e60\u9898","permalink":"/docs/Promise/test-case"}}');var s=r(5105),o=r(3881);const i={},a="\u624b\u5199 Promise",l={},c=[{value:"Promise \u5185\u90e8\u5b9e\u73b0",id:"promise-\u5185\u90e8\u5b9e\u73b0",level:2},{value:"\u5b9e\u73b0 Promise.resolve \u9759\u6001\u65b9\u6cd5",id:"\u5b9e\u73b0-promiseresolve-\u9759\u6001\u65b9\u6cd5",level:2},{value:"\u5b9e\u73b0 Promise.reject \u9759\u6001\u65b9\u6cd5",id:"\u5b9e\u73b0-promisereject-\u9759\u6001\u65b9\u6cd5",level:2},{value:"\u5b9e\u73b0 Promise.all \u9759\u6001\u65b9\u6cd5",id:"\u5b9e\u73b0-promiseall-\u9759\u6001\u65b9\u6cd5",level:2},{value:"\u5b9e\u73b0 Promise.allSettled \u9759\u6001\u65b9\u6cd5",id:"\u5b9e\u73b0-promiseallsettled-\u9759\u6001\u65b9\u6cd5",level:2},{value:"\u5b9e\u73b0 Promise.race \u9759\u6001\u65b9\u6cd5",id:"\u5b9e\u73b0-promiserace-\u9759\u6001\u65b9\u6cd5",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"\u624b\u5199-promise",children:"\u624b\u5199 Promise"})}),"\n",(0,s.jsx)(n.h2,{id:"promise-\u5185\u90e8\u5b9e\u73b0",children:"Promise \u5185\u90e8\u5b9e\u73b0"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",metastring:"title='MyPromise.ts'",children:'export enum PromiseState {\n  pending = "pending",\n  fulfilled = "fulfilled",\n  rejected = "rejected",\n}\n\ntype PromiseOnFulfilled<T extends unknown> = (value: T) => void;\n\ntype PromiseOnRejected = (reason: any) => void;\n\ntype PromiseHandler<T> = {\n  state: keyof typeof PromiseState;\n  executor?: PromiseOnFulfilled<T> | PromiseOnRejected;\n  resolve: PromiseOnFulfilled<T>;\n  reject: PromiseOnRejected;\n};\n\n/**\n * \u628a\u4e00\u4e2a\u51fd\u6570\u653e\u5230\u5fae\u961f\u5217\u91cc\u9762\u53bb\n */\nconst runMicroTask = (callback: () => void) => {\n  const p = document.createElement("p");\n  const observer = new MutationObserver(() => {\n    callback();\n  });\n  observer.observe(p, {\n    childList: true,\n  });\n  p.innerHTML = "1";\n};\n\nconst isPromise = (obj: any) => {\n  return !!(obj && typeof obj === "object" && typeof obj.then === "function");\n};\n\nclass MyPromise<T extends unknown> {\n  /**\n   * \u5185\u90e8\u72b6\u6001\n   */\n  private state: keyof typeof PromiseState = PromiseState.pending;\n\n  private value: T | undefined = undefined;\n\n  /**\n   * \u5b58\u653ethen\u51fd\u6570\u91cc\u9762onFulfilled \u548c onRejected \u7684\u56de\u8c03\u51fd\u6570\n   * \u901a\u8fc7 state \u6765\u533a\u5206 \u5b58\u653e\u7684\u662f \u6ce8\u518c\u7684\u56de\u8c03\u51fd\u6570 \u8fd8\u662f\u5931\u8d25\u7684\u56de\u8c03\u51fd\u6570\n   */\n  private handlers: PromiseHandler<T>[] = [];\n\n  /**\n   * \u521b\u5efa\u4e00\u4e2aPromise\n   * @param executor {Function}\n   */\n  constructor(\n    executor: (\n      resolve: PromiseOnFulfilled<T>,\n      reject: PromiseOnRejected\n    ) => void\n  ) {\n    try {\n      executor(this.resolve, this.reject);\n    } catch (e) {\n      this.reject(e);\n    }\n  }\n\n  private resolve = (value?: T) => {\n    this.changeState(PromiseState.fulfilled, value);\n  };\n\n  private reject = (reason: any) => {\n    this.changeState(PromiseState.rejected, reason);\n  };\n\n  /**\n   * \u66f4\u6539 \u4efb\u52a1\u7684\u72b6\u6001\n   * @param state\n   * @param value\n   * @returns\n   */\n  private changeState = (state: PromiseState, value: T | undefined) => {\n    if (this.state !== PromiseState.pending) {\n      return;\n    }\n    this.state = state;\n    this.value = value;\n    //\u72b6\u6001\u53d8\u5316\u6267\u884c\u961f\u5217\n    this.runHandlers();\n  };\n\n  /**\n   * \u628a onFulfilled \u548c onRejected \u6dfb\u52a0\u5230\u4efb\u52a1\u961f\u5217\u91cc\u9762\u53bb\n   * @param executor\n   * @param state\n   */\n  private pushHandlers = (\n    executor: PromiseHandler<T>["executor"],\n    state: PromiseHandler<T>["state"],\n    resolve: PromiseHandler<T>["resolve"],\n    reject: PromiseHandler<T>["reject"]\n  ) => {\n    this.handlers.push({\n      state,\n      executor,\n      resolve,\n      reject,\n    });\n  };\n\n  /**\n   * \u6267\u884c\u6ce8\u518c\u5230\u6570\u7ec4\u961f\u5217\u91cc\u9762\u7684\u51fd\u6570\n   */\n  private runHandlers = () => {\n    if (this.state === PromiseState.pending) {\n      return;\n    }\n    while (this.handlers[0]) {\n      this.runHandler(this.handlers[0]);\n      this.handlers.shift();\n    }\n  };\n\n  private runHandler = (handle: PromiseHandler<T>) => {\n    runMicroTask(() => {\n      if (handle.state !== this.state) {\n        return;\n      }\n      if (typeof handle.executor !== "function") {\n        this.state === PromiseState.fulfilled\n          ? handle.resolve(this.value as T)\n          : handle.reject(this.value);\n        return;\n      }\n      try {\n        const result = handle.executor(this.value as T);\n        if (isPromise(result)) {\n          result.then(handle.resolve, handle.reject);\n        } else {\n          handle.resolve(result as T);\n        }\n      } catch (error) {\n        handle.reject(error);\n      }\n    });\n  };\n\n  /**\n   * then \u6ce8\u518c\u7684 onFulfilled \u548c onRejected \u7684\u56de\u8c03\u51fd\u6570\u4e0d\u4f1a\u7acb\u5373\u6267\u884c \u4f1a\u653e\u5230\u5fae\u961f\u5217\u91cc\u9762\u53bb\n   * @param onFulfilled\n   * @param onRejected\n   * @returns MyPromise\n   */\n  then = (\n    onFulfilled?: PromiseOnFulfilled<T>,\n    onRejected?: PromiseOnRejected\n  ) => {\n    return new MyPromise((resolve, reject) => {\n      this.pushHandlers(onFulfilled, PromiseState.fulfilled, resolve, reject);\n      this.pushHandlers(onRejected, PromiseState.rejected, resolve, reject);\n      this.runHandlers();\n    });\n  };\n\n  /**\n /**\n   * then\u51fd\u6570 \u6355\u83b7\u5f02\u5e38\u9519\u8bef\u7684\u7b80\u5199\n   * @param onRejected\n   * @returns MyPromise\n   */\n  catch = (onRejected: PromiseOnRejected) => {\n    return this.then(undefined, onRejected);\n  };\n\n  /**\n   * \u5f53\u4efb\u52a1\u72b6\u6001\u4e0d\u662fpending\u7684\u65f6\u5019 \u5c31\u4f1a\u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\n   * @param onSettled\n   * @returns MyPromise\n   */\n  finally = (onSettled: () => void) => {\n    return this.then(\n      (data) => {\n        onSettled();\n        return data;\n      },\n      (reason) => {\n        onSettled();\n        return reason;\n      }\n    );\n  };\n}\n\nexport default MyPromise;\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u5b9e\u73b0-promiseresolve-\u9759\u6001\u65b9\u6cd5",children:"\u5b9e\u73b0 Promise.resolve \u9759\u6001\u65b9\u6cd5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"/**\n * 1\u3001\u4f20\u5165\u7684data\u53ef\u80fd\u662fES6\u7684Promise\n * 2\u3001\u4f20\u5165\u7684data\u4e5f\u53ef\u80fd\u662fPromiseLike (Promise A+)\u7684Promise \u72b6\u6001\u548c\u5176\u4fdd\u6301\u4e00\u81f4\u5373\u53ef\n */\nPromise.resolve = function (data) {\n  if (data instanceof Promise) {\n    return data;\n  }\n  return new Promise((resolve, reject) => {\n    if (isPromise(data)) {\n      data.then(resolve, reject);\n    } else {\n      resolve(data);\n    }\n  });\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u5b9e\u73b0-promisereject-\u9759\u6001\u65b9\u6cd5",children:"\u5b9e\u73b0 Promise.reject \u9759\u6001\u65b9\u6cd5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"Promise.reject = function (reason) {\n  return new Promise((resolve, reject) => {\n    reject(reason);\n  });\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u5b9e\u73b0-promiseall-\u9759\u6001\u65b9\u6cd5",children:"\u5b9e\u73b0 Promise.all \u9759\u6001\u65b9\u6cd5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"Promise.all = function (task) {\n  return new Promise((resolve, reject) => {\n    try {\n      let count = 0;\n      let fulfilledCount = 0;\n      let result = [];\n\n      for (const iterator of task) {\n        let i = count;\n        count++;\n        Promise.resolve(iterator).then((data) => {\n          fulfilledCount++;\n          result[i] = data;\n          if (fulfilledCount === count) {\n            resolve(result);\n          }\n        }, reject);\n      }\n\n      if (count === 0) {\n        resolve(result);\n      }\n    } catch (error) {\n      reject(error);\n    }\n  });\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u5b9e\u73b0-promiseallsettled-\u9759\u6001\u65b9\u6cd5",children:"\u5b9e\u73b0 Promise.allSettled \u9759\u6001\u65b9\u6cd5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'Promise.allSettled = function (task) {\n  const promiseHandlers = [];\n  for (const iterator of task) {\n    promiseHandlers.push(\n      iterator.then(\n        (data) => {\n          return {\n            value: data,\n            status: "fulfilled",\n          };\n        },\n        (reason) => {\n          return {\n            reason: reason,\n            status: "rejected",\n          };\n        }\n      )\n    );\n  }\n  return Promise.all(promiseHandlers);\n};\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u5b9e\u73b0-promiserace-\u9759\u6001\u65b9\u6cd5",children:"\u5b9e\u73b0 Promise.race \u9759\u6001\u65b9\u6cd5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"Promise.race = function (task) {\n  return new Promise((resolve, reject) => {\n    for (const iterator of task) {\n      Promise.resolve(iterator).then(resolve, reject);\n    }\n  });\n};\n"})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);